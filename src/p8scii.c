/** @file p8scii.c
 *
 *  A portable PICO-8 emulator written in C.
 *
 *  Copyright (c) 2025, Michael Fitzmayer. All rights reserved.
 *  SPDX-License-Identifier: MIT
 *
 **/

#include <stdint.h>
#include "memory.h"
#include "p8scii.h"

#define MAX_FONT_WIDTH 8
#define MAX_FONT_HEIGHT 8

typedef struct
{
    uint8_t width;
    uint8_t height;
    uint8_t bitmap[MAX_FONT_HEIGHT];

} p8char_t;

const p8char_t font[] =
{
    // Control codes.
    { 0, 0, { 0, 0, 0, 0, 0, } },
    { 0, 0, { 0, 0, 0, 0, 0, } },
    { 0, 0, { 0, 0, 0, 0, 0, } },
    { 0, 0, { 0, 0, 0, 0, 0, } },
    { 0, 0, { 0, 0, 0, 0, 0, } },
    { 0, 0, { 0, 0, 0, 0, 0, } },
    { 0, 0, { 0, 0, 0, 0, 0, } },
    { 0, 0, { 0, 0, 0, 0, 0, } },
    { 0, 0, { 0, 0, 0, 0, 0, } },
    { 0, 0, { 0, 0, 0, 0, 0, } },
    { 0, 0, { 0, 0, 0, 0, 0, } },
    { 0, 0, { 0, 0, 0, 0, 0, } },
    { 0, 0, { 0, 0, 0, 0, 0, } },
    { 0, 0, { 0, 0, 0, 0, 0, } },
    { 0, 0, { 0, 0, 0, 0, 0, } },
    { 0, 0, { 0, 0, 0, 0, 0, } },
    // Symbols and Japanese punctuation.
    { 3, 5, { 0b111, 0b111, 0b111, 0b111, 0b111 } }, // ▮
    { 3, 5, { 0b000, 0b111, 0b111, 0b111, 0b000 } }, // ■
    { 3, 5, { 0b000, 0b111, 0b101, 0b111, 0b000 } }, // □
    { 3, 5, { 0b000, 0b101, 0b010, 0b101, 0b000 } }, // ⁙
    { 3, 5, { 0b000, 0b101, 0b000, 0b101, 0b000 } }, // ⁘
    { 3, 5, { 0b000, 0b101, 0b101, 0b101, 0b000 } }, // ‖
    { 3, 5, { 0b001, 0b011, 0b111, 0b011, 0b001 } }, // ◀
    { 3, 5, { 0b100, 0b110, 0b111, 0b110, 0b100 } }, // ▶
    { 3, 5, { 0b111, 0b100, 0b100, 0b100, 0b000 } }, // 「
    { 3, 5, { 0b000, 0b001, 0b001, 0b001, 0b111 } }, // 」
    { 3, 5, { 0b101, 0b111, 0b010, 0b111, 0b010 } }, // ¥
    { 3, 5, { 0b000, 0b000, 0b010, 0b000, 0b000 } }, // •
    { 3, 5, { 0b000, 0b000, 0b000, 0b100, 0b010 } }, // 、
    { 3, 5, { 0b000, 0b000, 0b000, 0b110, 0b110 } }, // 。
    { 3, 5, { 0b101, 0b101, 0b000, 0b000, 0b000 } }, // ゛
    { 3, 5, { 0b010, 0b101, 0b010, 0b000, 0b000 } }, //゜
    // ASCII characters.
    { 3, 5, { 0b000, 0b000, 0b000, 0b000, 0b000 } }, // space
    { 3, 5, { 0b010, 0b010, 0b010, 0b000, 0b010 } }, // !
    { 3, 5, { 0b101, 0b101, 0b000, 0b000, 0b000 } }, // "
    { 3, 5, { 0b101, 0b111, 0b101, 0b111, 0b101 } }, // #
    { 3, 5, { 0b111, 0b110, 0b011, 0b111, 0b010 } }, // $
    { 3, 5, { 0b101, 0b001, 0b010, 0b100, 0b101 } }, // %
    { 3, 5, { 0b110, 0b110, 0b011, 0b101, 0b111 } }, // &
    { 3, 5, { 0b010, 0b100, 0b000, 0b000, 0b000 } }, // '
    { 3, 5, { 0b010, 0b100, 0b100, 0b100, 0b010 } }, // (
    { 3, 5, { 0b010, 0b001, 0b001, 0b001, 0b010 } }, // )
    { 3, 5, { 0b101, 0b010, 0b111, 0b010, 0b101 } }, // *
    { 3, 5, { 0b000, 0b010, 0b111, 0b010, 0b000 } }, // +
    { 3, 5, { 0b000, 0b000, 0b000, 0b010, 0b100 } }, // ,
    { 3, 5, { 0b000, 0b000, 0b111, 0b000, 0b000 } }, // -
    { 3, 5, { 0b000, 0b000, 0b000, 0b000, 0b010 } }, // .
    { 3, 5, { 0b001, 0b010, 0b010, 0b010, 0b100 } }, // /
    { 3, 5, { 0b111, 0b101, 0b101, 0b101, 0b111 } }, // 0
    { 3, 5, { 0b110, 0b010, 0b010, 0b010, 0b111 } }, // 1
    { 3, 5, { 0b111, 0b001, 0b111, 0b100, 0b111 } }, // 2
    { 3, 5, { 0b111, 0b001, 0b011, 0b001, 0b111 } }, // 3
    { 3, 5, { 0b101, 0b101, 0b111, 0b001, 0b001 } }, // 4
    { 3, 5, { 0b111, 0b100, 0b111, 0b001, 0b111 } }, // 5
    { 3, 5, { 0b100, 0b100, 0b111, 0b101, 0b111 } }, // 6
    { 3, 5, { 0b111, 0b001, 0b001, 0b001, 0b001 } }, // 7
    { 3, 5, { 0b111, 0b101, 0b111, 0b101, 0b111 } }, // 8
    { 3, 5, { 0b111, 0b101, 0b111, 0b001, 0b001 } }, // 9
    { 3, 5, { 0b000, 0b010, 0b000, 0b010, 0b000 } }, // :
    { 3, 5, { 0b000, 0b010, 0b000, 0b010, 0b100 } }, // ;
    { 3, 5, { 0b001, 0b010, 0b100, 0b010, 0b001 } }, // <
    { 3, 5, { 0b000, 0b111, 0b000, 0b111, 0b000 } }, // =
    { 3, 5, { 0b100, 0b010, 0b001, 0b010, 0b100 } }, // >
    { 3, 5, { 0b111, 0b001, 0b011, 0b000, 0b010 } }, // ?
    { 3, 5, { 0b010, 0b101, 0b101, 0b100, 0b011 } }, // @
    { 3, 5, { 0b000, 0b011, 0b101, 0b111, 0b101 } }, // A
    { 3, 5, { 0b000, 0b110, 0b110, 0b101, 0b111 } }, // B
    { 3, 5, { 0b000, 0b011, 0b100, 0b100, 0b011 } }, // C
    { 3, 5, { 0b000, 0b110, 0b101, 0b101, 0b110 } }, // D
    { 3, 5, { 0b000, 0b111, 0b110, 0b100, 0b011 } }, // E
    { 3, 5, { 0b000, 0b111, 0b110, 0b100, 0b100 } }, // F
    { 3, 5, { 0b000, 0b011, 0b100, 0b101, 0b111 } }, // G
    { 3, 5, { 0b000, 0b101, 0b101, 0b111, 0b101 } }, // H
    { 3, 5, { 0b000, 0b111, 0b010, 0b010, 0b111 } }, // I
    { 3, 5, { 0b000, 0b111, 0b010, 0b010, 0b110 } }, // J
    { 3, 5, { 0b000, 0b101, 0b110, 0b101, 0b101 } }, // K
    { 3, 5, { 0b000, 0b100, 0b100, 0b100, 0b011 } }, // L
    { 3, 5, { 0b000, 0b111, 0b111, 0b101, 0b101 } }, // M
    { 3, 5, { 0b000, 0b110, 0b101, 0b101, 0b101 } }, // N
    { 3, 5, { 0b000, 0b011, 0b101, 0b101, 0b110 } }, // O
    { 3, 5, { 0b000, 0b011, 0b101, 0b111, 0b100 } }, // P
    { 3, 5, { 0b000, 0b010, 0b101, 0b110, 0b011 } }, // Q
    { 3, 5, { 0b000, 0b110, 0b101, 0b110, 0b101 } }, // R
    { 3, 5, { 0b000, 0b011, 0b100, 0b001, 0b110 } }, // S
    { 3, 5, { 0b000, 0b111, 0b010, 0b010, 0b010 } }, // T
    { 3, 5, { 0b000, 0b101, 0b101, 0b101, 0b011 } }, // U
    { 3, 5, { 0b000, 0b101, 0b101, 0b111, 0b010 } }, // V
    { 3, 5, { 0b000, 0b101, 0b101, 0b111, 0b111 } }, // W
    { 3, 5, { 0b000, 0b101, 0b010, 0b010, 0b101 } }, // X
    { 3, 5, { 0b000, 0b101, 0b111, 0b001, 0b110 } }, // Y
    { 3, 5, { 0b000, 0b111, 0b001, 0b100, 0b111 } }, // Z
    { 3, 5, { 0b110, 0b100, 0b100, 0b100, 0b110 } }, // [
    { 3, 5, { 0b100, 0b010, 0b010, 0b010, 0b001 } }, // '\'
    { 3, 5, { 0b011, 0b001, 0b001, 0b001, 0b011 } }, // ]
    { 3, 5, { 0b010, 0b101, 0b000, 0b000, 0b000 } }, // ^
    { 3, 5, { 0b000, 0b000, 0b000, 0b000, 0b111 } }, // _
    { 3, 5, { 0b010, 0b001, 0b000, 0b000, 0b000 } }, // `
    { 3, 5, { 0b111, 0b101, 0b111, 0b101, 0b101 } }, // a
    { 3, 5, { 0b111, 0b101, 0b110, 0b101, 0b111 } }, // b
    { 3, 5, { 0b011, 0b100, 0b100, 0b100, 0b011 } }, // c
    { 3, 5, { 0b110, 0b101, 0b101, 0b101, 0b111 } }, // d
    { 3, 5, { 0b111, 0b100, 0b110, 0b100, 0b111 } }, // e
    { 3, 5, { 0b111, 0b100, 0b110, 0b100, 0b100 } }, // f
    { 3, 5, { 0b011, 0b100, 0b100, 0b101, 0b111 } }, // g
    { 3, 5, { 0b101, 0b101, 0b111, 0b101, 0b101 } }, // h
    { 3, 5, { 0b111, 0b010, 0b010, 0b010, 0b111 } }, // i
    { 3, 5, { 0b101, 0b010, 0b010, 0b010, 0b110 } }, // j
    { 3, 5, { 0b101, 0b101, 0b110, 0b101, 0b101 } }, // k
    { 3, 5, { 0b100, 0b100, 0b100, 0b100, 0b111 } }, // l
    { 3, 5, { 0b111, 0b111, 0b101, 0b101, 0b101 } }, // m
    { 3, 5, { 0b110, 0b101, 0b101, 0b101, 0b101 } }, // n
    { 3, 5, { 0b011, 0b101, 0b101, 0b101, 0b110 } }, // o
    { 3, 5, { 0b111, 0b101, 0b111, 0b100, 0b100 } }, // p
    { 3, 5, { 0b010, 0b101, 0b101, 0b110, 0b011 } }, // q
    { 3, 5, { 0b111, 0b101, 0b110, 0b101, 0b101 } }, // r
    { 3, 5, { 0b011, 0b100, 0b111, 0b001, 0b110 } }, // s
    { 3, 5, { 0b111, 0b010, 0b010, 0b010, 0b010 } }, // t
    { 3, 5, { 0b101, 0b101, 0b101, 0b101, 0b011 } }, // u
    { 3, 5, { 0b101, 0b101, 0b101, 0b111, 0b010 } }, // v
    { 3, 5, { 0b101, 0b101, 0b101, 0b111, 0b111 } }, // w
    { 3, 5, { 0b101, 0b101, 0b010, 0b101, 0b101 } }, // x
    { 3, 5, { 0b101, 0b101, 0b111, 0b001, 0b111 } }, // y
    { 3, 5, { 0b111, 0b001, 0b010, 0b101, 0b101 } }, // z
    { 3, 5, { 0b011, 0b010, 0b110, 0b010, 0b011 } }, // {
    { 3, 5, { 0b010, 0b010, 0b010, 0b010, 0b010 } }, // |
    { 3, 5, { 0b110, 0b010, 0b011, 0b010, 0b110 } }, // }
    { 3, 5, { 0b000, 0b001, 0b111, 0b100, 0b000 } }, // ~
    // Typeable symbols.
    { 0, 0, { 0, 0, 0, 0, 0, } }, // ○
    { 0, 0, { 0, 0, 0, 0, 0, } }, // █
    { 0, 0, { 0, 0, 0, 0, 0, } }, // ▒
    { 0, 0, { 0, 0, 0, 0, 0, } }, // 🐱
    { 0, 0, { 0, 0, 0, 0, 0, } }, // ⬇️
    { 0, 0, { 0, 0, 0, 0, 0, } }, // ░
    { 0, 0, { 0, 0, 0, 0, 0, } }, // ✽
    { 0, 0, { 0, 0, 0, 0, 0, } }, // ●
    { 0, 0, { 0, 0, 0, 0, 0, } }, // ♥
    { 0, 0, { 0, 0, 0, 0, 0, } }, // ☉
    { 0, 0, { 0, 0, 0, 0, 0, } }, // 웃
    { 0, 0, { 0, 0, 0, 0, 0, } }, // ⌂
    { 0, 0, { 0, 0, 0, 0, 0, } }, // ⬅️
    { 0, 0, { 0, 0, 0, 0, 0, } }, // 😐
    { 0, 0, { 0, 0, 0, 0, 0, } }, // ♪
    { 0, 0, { 0, 0, 0, 0, 0, } }, // 🅾️
    { 0, 0, { 0, 0, 0, 0, 0, } }, // ◆
    { 0, 0, { 0, 0, 0, 0, 0, } }, // …
    { 0, 0, { 0, 0, 0, 0, 0, } }, // ➡️
    { 0, 0, { 0, 0, 0, 0, 0, } }, // ★
    { 0, 0, { 0, 0, 0, 0, 0, } }, // ⧗
    { 0, 0, { 0, 0, 0, 0, 0, } }, // ⬆️
    { 0, 0, { 0, 0, 0, 0, 0, } }, // ˇ
    { 0, 0, { 0, 0, 0, 0, 0, } }, // ∧
    { 0, 0, { 0, 0, 0, 0, 0, } }, // ❎
    { 0, 0, { 0, 0, 0, 0, 0, } }, // ▤
    { 0, 0, { 0, 0, 0, 0, 0, } }, // ▥
    // Hiragana.
    { 0, 0, { 0, 0, 0, 0, 0, } }, // あ
    { 0, 0, { 0, 0, 0, 0, 0, } }, // い
    { 0, 0, { 0, 0, 0, 0, 0, } }, // う
    { 0, 0, { 0, 0, 0, 0, 0, } }, // え
    { 0, 0, { 0, 0, 0, 0, 0, } }, // お
    { 0, 0, { 0, 0, 0, 0, 0, } }, // か
    { 0, 0, { 0, 0, 0, 0, 0, } }, // き
    { 0, 0, { 0, 0, 0, 0, 0, } }, // く
    { 0, 0, { 0, 0, 0, 0, 0, } }, // け
    { 0, 0, { 0, 0, 0, 0, 0, } }, // こ
    { 0, 0, { 0, 0, 0, 0, 0, } }, // さ
    { 0, 0, { 0, 0, 0, 0, 0, } }, // し
    { 0, 0, { 0, 0, 0, 0, 0, } }, // す
    { 0, 0, { 0, 0, 0, 0, 0, } }, // せ
    { 0, 0, { 0, 0, 0, 0, 0, } }, // そ
    { 0, 0, { 0, 0, 0, 0, 0, } }, // た
    { 0, 0, { 0, 0, 0, 0, 0, } }, // ち
    { 0, 0, { 0, 0, 0, 0, 0, } }, // つ
    { 0, 0, { 0, 0, 0, 0, 0, } }, // て
    { 0, 0, { 0, 0, 0, 0, 0, } }, // と
    { 0, 0, { 0, 0, 0, 0, 0, } }, // な
    { 0, 0, { 0, 0, 0, 0, 0, } }, // に
    { 0, 0, { 0, 0, 0, 0, 0, } }, // ぬ
    { 0, 0, { 0, 0, 0, 0, 0, } }, // ね
    { 0, 0, { 0, 0, 0, 0, 0, } }, // の
    { 0, 0, { 0, 0, 0, 0, 0, } }, // は
    { 0, 0, { 0, 0, 0, 0, 0, } }, // ひ
    { 0, 0, { 0, 0, 0, 0, 0, } }, // ふ
    { 0, 0, { 0, 0, 0, 0, 0, } }, // へ
    { 0, 0, { 0, 0, 0, 0, 0, } }, // ほ
    { 0, 0, { 0, 0, 0, 0, 0, } }, // ま
    { 0, 0, { 0, 0, 0, 0, 0, } }, // み
    { 0, 0, { 0, 0, 0, 0, 0, } }, // む
    { 0, 0, { 0, 0, 0, 0, 0, } }, // め
    { 0, 0, { 0, 0, 0, 0, 0, } }, // も
    { 0, 0, { 0, 0, 0, 0, 0, } }, // や
    { 0, 0, { 0, 0, 0, 0, 0, } }, // ゆ
    { 0, 0, { 0, 0, 0, 0, 0, } }, // よ
    { 0, 0, { 0, 0, 0, 0, 0, } }, // ら
    { 0, 0, { 0, 0, 0, 0, 0, } }, // り
    { 0, 0, { 0, 0, 0, 0, 0, } }, // る
    { 0, 0, { 0, 0, 0, 0, 0, } }, // れ
    { 0, 0, { 0, 0, 0, 0, 0, } }, // ろ
    { 0, 0, { 0, 0, 0, 0, 0, } }, // わ
    { 0, 0, { 0, 0, 0, 0, 0, } }, // を
    { 0, 0, { 0, 0, 0, 0, 0, } }, // ん
    { 0, 0, { 0, 0, 0, 0, 0, } }, // っ
    { 0, 0, { 0, 0, 0, 0, 0, } }, // ゃ
    { 0, 0, { 0, 0, 0, 0, 0, } }, // ゅ
    { 0, 0, { 0, 0, 0, 0, 0, } }, // ょ
    // Katakana.
    { 0, 0, { 0, 0, 0, 0, 0, } }, // ア
    { 0, 0, { 0, 0, 0, 0, 0, } }, // イ
    { 0, 0, { 0, 0, 0, 0, 0, } }, // ウ
    { 0, 0, { 0, 0, 0, 0, 0, } }, // エ
    { 0, 0, { 0, 0, 0, 0, 0, } }, // オ
    { 0, 0, { 0, 0, 0, 0, 0, } }, // カ
    { 0, 0, { 0, 0, 0, 0, 0, } }, // キ
    { 0, 0, { 0, 0, 0, 0, 0, } }, // ク
    { 0, 0, { 0, 0, 0, 0, 0, } }, // ケ
    { 0, 0, { 0, 0, 0, 0, 0, } }, // コ
    { 0, 0, { 0, 0, 0, 0, 0, } }, // サ
    { 0, 0, { 0, 0, 0, 0, 0, } }, // シ
    { 0, 0, { 0, 0, 0, 0, 0, } }, // ス
    { 0, 0, { 0, 0, 0, 0, 0, } }, // セ
    { 0, 0, { 0, 0, 0, 0, 0, } }, // ソ
    { 0, 0, { 0, 0, 0, 0, 0, } }, // タ
    { 0, 0, { 0, 0, 0, 0, 0, } }, // チ
    { 0, 0, { 0, 0, 0, 0, 0, } }, // ツ
    { 0, 0, { 0, 0, 0, 0, 0, } }, // テ
    { 0, 0, { 0, 0, 0, 0, 0, } }, // ト
    { 0, 0, { 0, 0, 0, 0, 0, } }, // ナ
    { 0, 0, { 0, 0, 0, 0, 0, } }, // ニ
    { 0, 0, { 0, 0, 0, 0, 0, } }, // ヌ
    { 0, 0, { 0, 0, 0, 0, 0, } }, // ネ
    { 0, 0, { 0, 0, 0, 0, 0, } }, // ノ
    { 0, 0, { 0, 0, 0, 0, 0, } }, // ハ
    { 0, 0, { 0, 0, 0, 0, 0, } }, // ヒ
    { 0, 0, { 0, 0, 0, 0, 0, } }, // フ
    { 0, 0, { 0, 0, 0, 0, 0, } }, // ヘ
    { 0, 0, { 0, 0, 0, 0, 0, } }, // ホ
    { 0, 0, { 0, 0, 0, 0, 0, } }, // マ
    { 0, 0, { 0, 0, 0, 0, 0, } }, // ミ
    { 0, 0, { 0, 0, 0, 0, 0, } }, // ム
    { 0, 0, { 0, 0, 0, 0, 0, } }, // メ
    { 0, 0, { 0, 0, 0, 0, 0, } }, // モ
    { 0, 0, { 0, 0, 0, 0, 0, } }, // ヤ
    { 0, 0, { 0, 0, 0, 0, 0, } }, // ユ
    { 0, 0, { 0, 0, 0, 0, 0, } }, // ヨ
    { 0, 0, { 0, 0, 0, 0, 0, } }, // ラ
    { 0, 0, { 0, 0, 0, 0, 0, } }, // リ
    { 0, 0, { 0, 0, 0, 0, 0, } }, // ル
    { 0, 0, { 0, 0, 0, 0, 0, } }, // レ
    { 0, 0, { 0, 0, 0, 0, 0, } }, // ロ
    { 0, 0, { 0, 0, 0, 0, 0, } }, // ワ
    { 0, 0, { 0, 0, 0, 0, 0, } }, // ヲ
    { 0, 0, { 0, 0, 0, 0, 0, } }, // ン
    { 0, 0, { 0, 0, 0, 0, 0, } }, // ッ
    { 0, 0, { 0, 0, 0, 0, 0, } }, // ャ
    { 0, 0, { 0, 0, 0, 0, 0, } }, // ュ
    { 0, 0, { 0, 0, 0, 0, 0, } }, // ョ
    // Remaining symbols.
    { 0, 0, { 0, 0, 0, 0, 0, } }, // ◜
    { 0, 0, { 0, 0, 0, 0, 0, } }, // ◝
};

void blit_char_to_screen(uint8_t char_index, int x, int y, uint8_t color, uint8_t* w, uint8_t* h)
{
    const p8char_t* font_char = &font[char_index];
    const uint8_t* char_bitmap = font_char->bitmap;

    for (int row = 0; row < font_char->height; row++)
    {
        uint8_t row_data = char_bitmap[row];
        for (int col = 0; col < font_char->width; col++)
        {
            if (row_data & (1 << (font_char->width - 1 - col)))
            {
                int screen_x = x + col;
                int screen_y = y + row;
                uint16_t addr = 0x6000 + (screen_y << 6) + (screen_x >> 1);
                uint8_t mask = (screen_x & 1) ? 0x0F : 0xF0;
                uint8_t shift = (screen_x & 1) ? 4 : 0;
                pico8_ram[addr] = (pico8_ram[addr] & mask) | (color << shift);
                *w = font_char->width;
                *h = font_char->height;
            }
        }
    }
}
